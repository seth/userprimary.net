#!/usr/bin/env ruby

compile '/posts/' do
  filter :haml
  layout 'default'
end

compile '/posts/*' do
  filter :bluecloth
  layout 'default'
end

compile '/tags/' do
  filter :haml
  layout 'default'
end

compile '/tags/*' do
  filter :haml
  layout 'default'
  filter :erb
end

compile '*' do
  filter :erb
  layout 'default'
end

route '*' do
  item.identifier + 'index.html'
end

layout '/tag/', :erb
layout '/tag2/', :haml

layout '*', :erb

preprocess do
  require 'set'
  tags = Hash.new { |h, k| h[k] = 0 }
  items.each do |item|
    if item[:tags]
      item[:tags].each { |t| tags[t] += 1 }
    end
  end  

  tags.each do |tag, count|
    items << Nanoc3::Item.new(%[<%= render('tag', :tag_name => "#{tag}", :tag_count => "#{count}") %>],
                              { :title => "Category: #{tag}",
                                :tag_name => tag,
                                :tag_count => count.to_s
                              },
                              "/tags/#{tag}/")
  end
  # items << Nanoc3::Item.new("",
  #                           { :title => "All Tags" },
  #                           "/tags/")
  #                           )
end
